<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h2 class="font-serif mb-1">Culinary Management</h2>
        <p class="text-muted small mb-0">Digital Menu Curator</p>
    </div>
    <% if (user.role === 'admin' || user.role === 'manager') { %>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal">+ New Menu Entry</button>
    <% } %>
</div>

<div class="row">
    <% ['food', 'deserts', 'wine'].forEach(cat => { %>
    <div class="col-12 mb-5">
        <h6 class="text-uppercase text-primary border-bottom pb-2 mb-3" style="letter-spacing: 0.1em;"><%= cat === 'deserts' ? 'Desserts' : cat.charAt(0).toUpperCase() + cat.slice(1) %></h6>
        <div class="card border-0 shadow-sm overflow-hidden">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small">
                    <tr>
                        <th class="ps-4" style="width: 40%">Item</th>
                        <th class="text-center" style="width: 20%">Price</th>
                        <th class="text-center" style="width: 20%">Visibility</th>
                        <% if (user.role === 'admin' || user.role === 'manager') { %>
                            <th class="text-end pe-4" style="width: 20%">Actions</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <% menu.filter(i => i.category === cat).forEach(item => { %>
                    <tr class="<%= item.is_available ? '' : 'bg-light text-muted opacity-75' %>">
                        <td class="ps-4">
                            <div class="fw-bold"><%= item.name %></div>
                            <div class="small text-muted"><%= item.description %></div>
                        </td>
                        <td class="fw-bold text-center">$<%= item.price.toFixed(2) %></td>
                        <td class="text-center">
                            <span class="badge <%= item.is_available ? 'bg-success' : 'bg-secondary' %> status-badge">
                                <%= item.is_available ? 'Live' : 'Hidden' %>
                            </span>
                        </td>
                        <% if (user.role === 'admin' || user.role === 'manager') { %>
                            <td class="text-end pe-4">
                                <div class="d-flex gap-1 justify-content-end">
                                    <button class="btn btn-sm btn-outline-dark" data-item="<%- encodeURIComponent(JSON.stringify(item)) %>" onclick="editItem(this)">Edit</button>
                                    <form action="/restaurant-admin/<%= item.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Delete this item?')">
                                        <button class="btn btn-sm btn-outline-danger">Delete</button>
                                    </form>
                                </div>
                            </td>
                        <% } %>
                    </tr>
                    <% }) %>
                    <% if (menu.filter(i => i.category === cat).length === 0) { %>
                    <tr><td colspan="4" class="text-center py-4 text-muted">No items in this category</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
    <% }) %>
</div>

<!-- Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/restaurant-admin" method="POST" class="modal-content border-0 rounded-0">
            <div class="modal-header bg-dark text-white border-0">
                <h5 class="modal-title fw-bold">Menu Item Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="id" id="item_id">
                <div class="mb-3">
                    <label class="form-label small fw-bold">CATEGORY</label>
                    <select name="category" id="item_cat" class="form-select">
                        <option value="food">Food</option>
                        <option value="deserts">Desserts</option>
                        <option value="wine">Wine</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">ITEM NAME</label>
                    <input type="text" name="name" id="item_name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">DESCRIPTION</label>
                    <textarea name="description" id="item_desc" class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">PRICE ($)</label>
                    <input type="number" name="price" id="item_price" class="form-control" step="0.01" required>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="is_available" id="item_available" checked>
                    <label class="form-check-label small fw-bold">AVAILABLE ON SITE</label>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-primary w-100">SAVE CHANGES</button>
            </div>
        </form>
    </div>
</div>

<script>
function editItem(button) {
    const item = JSON.parse(decodeURIComponent(button.dataset.item));
    document.getElementById('item_id').value = item.id;
    document.getElementById('item_cat').value = item.category;
    document.getElementById('item_name').value = item.name;
    document.getElementById('item_desc').value = item.description;
    document.getElementById('item_price').value = item.price;
    document.getElementById('item_available').checked = item.is_available === 1;
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}
</script>

<%- include('partials/footer') %>
