<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="font-serif mb-1">Bookings Management</h2>
        <span class="text-muted small"><%= pagination.totalRecords %> total records</span>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newBookingModal">+ Walk-in Booking</button>
</div>

<!-- Search & Filter -->
<div class="card border-0 shadow-sm p-3 mb-4">
    <form method="GET" action="/bookings" class="d-flex gap-3 align-items-end">
        <div class="search-bar flex-grow-1">
            <label class="form-label small fw-bold mb-1">SEARCH</label>
            <input type="text" name="search" class="form-control form-control-sm" placeholder="Guest name, phone, room..." value="<%= search %>">
        </div>
        <div>
            <label class="form-label small fw-bold mb-1">STATUS</label>
            <select name="status" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="pending" <%= statusFilter === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="approved" <%= statusFilter === 'approved' ? 'selected' : '' %>>Approved</option>
                <option value="checked_in" <%= statusFilter === 'checked_in' ? 'selected' : '' %>>Checked In</option>
                <option value="checked_out" <%= statusFilter === 'checked_out' ? 'selected' : '' %>>Checked Out</option>
                <option value="cancelled" <%= statusFilter === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                <option value="rejected" <%= statusFilter === 'rejected' ? 'selected' : '' %>>Rejected</option>
            </select>
        </div>
        <button type="submit" class="btn btn-dark btn-sm px-4">Filter</button>
        <% if (search || statusFilter) { %>
            <a href="/bookings" class="btn btn-outline-secondary btn-sm">Clear</a>
        <% } %>
    </form>
</div>

<div class="card border-0 shadow-sm overflow-hidden">
    <table class="table table-hover align-middle mb-0">
        <thead class="bg-dark text-white text-[10px] uppercase">
            <tr>
                <th class="ps-4 py-3">Guest</th>
                <th class="py-3">Room</th>
                <th class="py-3">Dates</th>
                <th class="py-3">Method</th>
                <th class="py-3">Total</th>
                <th class="py-3">Source</th>
                <th class="py-3">Status</th>
                <th class="py-3 text-end pe-4">Actions</th>
            </tr>
        </thead>
        <tbody>
            <% bookings.forEach(booking => { %>
            <tr>
                <td class="ps-4">
                    <div class="fw-bold"><%= booking.guest_name %></div>
                    <div class="text-muted small"><%= booking.phone_number %></div>
                    <% if (booking.guest_email) { %>
                        <div class="text-muted small"><%= booking.guest_email %></div>
                    <% } %>
                </td>
                <td>
                    <span class="fw-bold"><%= booking.room_number %></span>
                    <% if (booking.type_name) { %>
                        <br><span class="text-muted small"><%= booking.type_name %></span>
                    <% } %>
                </td>
                <td>
                    <div class="small"><%= booking.check_in_date %></div>
                    <div class="text-muted small">to <%= booking.check_out_date %></div>
                </td>
                <td>
                    <% if (booking.payment_method) { %>
                        <span class="badge bg-light text-dark border"><%= booking.payment_method.toUpperCase() %></span>
                    <% } else { %>
                        <span class="text-muted small">Unset</span>
                    <% } %>
                </td>
                <td class="fw-bold">$<%= booking.total_price.toFixed(2) %></td>
                <td><span class="badge bg-secondary status-badge"><%= booking.source %></span></td>
                <td>
                    <% if (booking.status === 'approved') { %>
                        <span class="badge bg-success status-badge">Approved</span>
                    <% } else if (booking.status === 'pending') { %>
                        <span class="badge bg-warning text-dark status-badge">Pending</span>
                    <% } else if (booking.status === 'checked_in') { %>
                        <span class="badge bg-primary status-badge">Checked In</span>
                    <% } else if (booking.status === 'checked_out') { %>
                        <span class="badge bg-info status-badge">Checked Out</span>
                    <% } else if (booking.status === 'cancelled') { %>
                        <span class="badge bg-dark status-badge">Cancelled</span>
                    <% } else if (booking.status === 'rejected') { %>
                        <span class="badge bg-danger status-badge">Rejected</span>
                    <% } %>
                </td>
                <td class="text-end pe-4">
                    <div class="d-flex gap-1 justify-content-end flex-wrap">
                        <% if (booking.status === 'approved') { %>
                            <form action="/bookings/<%= booking.id %>/check-in" method="POST" class="d-inline">
                                <button class="btn btn-sm btn-success">Check In</button>
                            </form>
                        <% } %>
                        <% if (booking.status === 'checked_in') { %>
                            <form action="/bookings/<%= booking.id %>/check-out" method="POST" class="d-inline">
                                <button class="btn btn-sm btn-info">Check Out</button>
                            </form>
                        <% } %>
                        <% if (['pending', 'approved', 'checked_in'].includes(booking.status)) { %>
                            <form action="/bookings/<%= booking.id %>/cancel" method="POST" class="d-inline" onsubmit="return confirm('Cancel this booking?')">
                                <button class="btn btn-sm btn-outline-danger">Cancel</button>
                            </form>
                        <% } %>
                        <a href="/bookings/<%= booking.id %>/invoice" class="btn btn-sm btn-outline-dark">Invoice</a>
                    </div>
                </td>
            </tr>
            <% }) %>
            <% if (bookings.length === 0) { %>
            <tr><td colspan="7" class="text-center py-5 text-muted">No bookings found</td></tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<% if (pagination.total > 1) { %>
<nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
        <% if (pagination.current > 1) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= pagination.current - 1 %>&search=<%= search %>&status=<%= statusFilter %>">Prev</a></li>
        <% } %>
        <% for (let i = 1; i <= pagination.total; i++) { %>
            <li class="page-item <%= pagination.current === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= search %>&status=<%= statusFilter %>"><%= i %></a>
            </li>
        <% } %>
        <% if (pagination.current < pagination.total) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= pagination.current + 1 %>&search=<%= search %>&status=<%= statusFilter %>">Next</a></li>
        <% } %>
    </ul>
</nav>
<% } %>

<!-- New Booking Modal -->
<div class="modal fade" id="newBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/bookings" method="POST" class="modal-content border-0 rounded-0">
            <div class="modal-header bg-dark text-white border-0">
                <h5 class="modal-title">New Walk-in Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label small fw-bold">GUEST NAME *</label>
                        <input type="text" name="guest_name" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small fw-bold">PHONE NUMBER *</label>
                        <input type="tel" name="phone_number" class="form-control" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label small fw-bold">EMAIL</label>
                        <input type="email" name="guest_email" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small fw-bold">TELEGRAM</label>
                        <input type="text" name="telegram" class="form-control" placeholder="@username">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">ROOM *</label>
                    <select name="room_id" class="form-select" required>
                        <option value="">Select a room</option>
                        <% rooms.forEach(room => { %>
                            <option value="<%= room.id %>"><%= room.room_number %> - <%= room.type_name %> ($<%= room.base_price || '' %>)</option>
                        <% }) %>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label small fw-bold">CHECK-IN *</label>
                        <input type="date" name="check_in_date" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small fw-bold">CHECK-OUT *</label>
                        <input type="date" name="check_out_date" class="form-control" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">PAYMENT METHOD</label>
                    <select name="payment_method" class="form-select">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="bank_transfer">Bank Transfer</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">SPECIAL REQUESTS</label>
                    <textarea name="special_requests" class="form-control" rows="2" maxlength="500"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-primary w-100 py-2">CONFIRM BOOKING</button>
            </div>
        </form>
    </div>
</div>

<%- include('partials/footer') %>
