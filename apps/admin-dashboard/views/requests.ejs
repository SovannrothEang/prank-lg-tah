<%- include('partials/header'); %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="font-serif mb-1">Online Guest Requests</h2>
        <span class="text-muted small"><%= pagination.totalRecords %> total requests</span>
    </div>
</div>

<!-- Search -->
<div class="card border-0 shadow-sm p-3 mb-4">
    <form method="GET" action="/requests" class="d-flex gap-3 align-items-end">
        <div class="search-bar flex-grow-1">
            <label class="form-label small fw-bold mb-1">SEARCH</label>
            <input type="text" name="search" class="form-control form-control-sm" placeholder="Guest name, phone, telegram..." value="<%= search %>">
        </div>
        <button type="submit" class="btn btn-dark btn-sm px-4">Search</button>
        <% if (search) { %>
            <a href="/requests" class="btn btn-outline-secondary btn-sm">Clear</a>
        <% } %>
    </form>
</div>

<div class="card overflow-hidden border-0 shadow-sm">
    <table class="table table-hover align-middle mb-0">
        <thead class="bg-dark text-white text-[10px] uppercase tracking-widest">
            <tr>
                <th class="ps-4 py-3">Guest Contact</th>
                <th class="py-3">Residency</th>
                <th class="py-3">Stay Data</th>
                <th class="py-3">Total</th>
                <th class="py-3 text-end pe-4">Decisions</th>
            </tr>
        </thead>
        <tbody>
            <% requests.forEach(request => { %>
            <tr>
                <td class="ps-4">
                    <div class="fw-bold"><%= request.guest_name %></div>
                    <div class="text-primary small">TG: <%= request.telegram || 'N/A' %></div>
                    <% if (request.phone_number) { %>
                        <div class="text-muted small">TEL: <%= request.phone_number %></div>
                    <% } %>
                    <% if (request.special_requests) { %>
                        <div class="text-muted small mt-1" title="<%= request.special_requests %>">Note: <%= request.special_requests.substring(0, 40) %><%= request.special_requests.length > 40 ? '...' : '' %></div>
                    <% } %>
                </td>
                <td>
                    <div class="small fw-bold"><%= request.type_name || 'Standard' %></div>
                    <div class="text-muted small">$<%= (request.base_price || 0).toFixed(2) %>/night</div>
                    <div class="text-muted small">Room: <%= request.room_number || 'N/A' %></div>
                </td>
                <td>
                    <div class="small"><%= request.check_in_date %> <span class="text-muted">&rarr;</span> <%= request.check_out_date %></div>
                </td>
                <td class="fw-bold">$<%= (request.total_price || 0).toFixed(2) %></td>
                <td class="text-end pe-4">
                    <% if (request.status === 'pending') { %>
                        <div class="d-flex gap-1 justify-content-end">
                            <form action="/requests/<%= request.id %>/approve" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-dark px-3">Approve</button>
                            </form>
                            <form action="/requests/<%= request.id %>/reject" method="POST" class="d-inline" onsubmit="return confirm('Reject this request?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger px-3">Reject</button>
                            </form>
                        </div>
                    <% } else { %>
                        <span class="badge status-badge <%= request.status === 'approved' ? 'bg-success' : (request.status === 'rejected' ? 'bg-danger' : 'bg-secondary') %>"><%= request.status %></span>
                    <% } %>
                </td>
            </tr>
            <% }) %>
            <% if (requests.length === 0) { %>
            <tr><td colspan="5" class="text-center py-5 text-muted">No requests found</td></tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<% if (pagination.total > 1) { %>
<nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
        <% if (pagination.current > 1) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= pagination.current - 1 %>&search=<%= search %>">Prev</a></li>
        <% } %>
        <% for (let i = 1; i <= pagination.total; i++) { %>
            <li class="page-item <%= pagination.current === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
            </li>
        <% } %>
        <% if (pagination.current < pagination.total) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= pagination.current + 1 %>&search=<%= search %>">Next</a></li>
        <% } %>
    </ul>
</nav>
<% } %>

<%- include('partials/footer'); %>
