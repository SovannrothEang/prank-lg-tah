<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="font-serif mb-1">Audit Trail</h2>
        <p class="text-muted small mb-0">System-wide activity and security logs</p>
    </div>
    <div class="search-bar">
        <form action="/audit" method="GET">
            <input type="text" name="search" class="form-control form-control-sm" placeholder="Search action, user, table..." value="<%= search %>">
        </form>
    </div>
</div>

<div class="card border-0 shadow-sm overflow-hidden">
    <table class="table table-hover align-middle mb-0">
        <thead class="bg-dark text-white text-[10px] uppercase tracking-widest">
            <tr>
                <th class="ps-4 py-3">Timestamp</th>
                <th class="py-3">User</th>
                <th class="py-3">Action</th>
                <th class="py-3">Resource</th>
                <th class="py-3">Changes</th>
                <th class="py-3">IP Address</th>
            </tr>
        </thead>
        <tbody class="small">
            <% logs.forEach(log => { %>
            <tr>
                <td class="ps-4 text-muted">
                    <%= new Date(log.created_at).toLocaleString() %>
                </td>
                <td>
                    <% if (log.user_name) { %>
                        <div class="fw-bold"><%= log.user_name %></div>
                        <div class="text-muted" style="font-size: 0.7rem;"><%= log.user_role.toUpperCase() %></div>
                    <% } else { %>
                        <span class="text-muted italic">System / Public</span>
                    <% } %>
                </td>
                <td>
                    <span class="badge <%= log.action.includes('DELETE') ? 'bg-danger' : (log.action.includes('CREATE') ? 'bg-success' : 'bg-primary') %> status-badge">
                        <%= log.action %>
                    </span>
                </td>
                <td>
                    <div class="fw-bold"><%= log.table_name %></div>
                    <div class="text-muted" style="font-size: 0.7rem;">ID: <%= log.record_id || 'N/A' %></div>
                </td>
                <td>
                    <% if (log.old_value || log.new_value) { %>
                        <button class="btn btn-sm btn-outline-dark" style="font-size: 0.65rem;" 
                                onclick="viewDiff('<%- JSON.stringify(log.old_value).replace(/'/g, "\\'") %>', '<%- JSON.stringify(log.new_value).replace(/'/g, "\\'") %>')">
                            View Data
                        </button>
                    <% } else { %>
                        <span class="text-muted">--</span>
                    <% } %>
                </td>
                <td class="text-muted"><%= log.ip_address || '0.0.0.0' %></td>
            </tr>
            <% }) %>
            <% if (logs.length === 0) { %>
                <tr><td colspan="6" class="text-center py-5 text-muted">No audit logs found matching criteria</td></tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<% if (pagination.total > 1) { %>
<nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
        <% if (pagination.current > 1) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= pagination.current - 1 %>&search=<%= search %>">Prev</a></li>
        <% } %>
        <% for (let i = 1; i <= pagination.total; i++) { %>
            <li class="page-item <%= pagination.current === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
            </li>
        <% } %>
        <% if (pagination.current < pagination.total) { %>
            <li class="page-item"><a class="page-link" href="?page=<%= pagination.current + 1 %>&search=<%= search %>">Next</a></li>
        <% } %>
    </ul>
</nav>
<% } %>

<!-- Diff Modal -->
<div class="modal fade" id="diffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 rounded-0">
            <div class="modal-header bg-dark text-white border-0">
                <h6 class="modal-title">Log Data Changes</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="small fw-bold text-muted mb-2">PREVIOUS STATE</label>
                        <pre id="oldVal" class="p-3 bg-white border rounded small" style="max-height: 400px; overflow: auto;"></pre>
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold text-muted mb-2">NEW STATE</label>
                        <pre id="newVal" class="p-3 bg-white border rounded small" style="max-height: 400px; overflow: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function viewDiff(oldVal, newVal) {
    const parse = (str) => {
        try { return JSON.stringify(JSON.parse(str), null, 2); }
        catch (e) { return str || 'None'; }
    };
    document.getElementById('oldVal').textContent = parse(oldVal);
    document.getElementById('newVal').textContent = parse(newVal);
    new bootstrap.Modal(document.getElementById('diffModal')).show();
}
</script>

<%- include('partials/footer') %>
