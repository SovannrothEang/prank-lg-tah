<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="font-serif">Staff Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newStaffModal">+ Register New Staff</button>
</div>

<div class="card border-0 shadow-sm overflow-hidden">
    <table class="table table-hover align-middle mb-0">
        <thead class="bg-dark text-white">
            <tr>
                <th class="ps-4">Full Name</th>
                <th>Username</th>
                <th>Role</th>
                <th>Status</th>
                <th>Joined</th>
                <th class="text-end pe-4">Actions</th>
            </tr>
        </thead>
        <tbody>
            <% staff.forEach(s => { %>
            <tr class="<%= s.is_active ? '' : 'bg-light opacity-75' %>">
                <td class="ps-4 fw-bold"><%= s.full_name %></td>
                <td><code class="text-primary"><%= s.username %></code></td>
                <td><span class="badge bg-dark status-badge"><%= s.role %></span></td>
                <td>
                    <span class="badge <%= s.is_active ? 'bg-success' : 'bg-danger' %> status-badge">
                        <%= s.is_active ? 'Active' : 'Inactive' %>
                    </span>
                </td>
                <td class="small"><%= new Date(s.created_at).toLocaleDateString() %></td>
                <td class="text-end pe-4">
                    <% if (s.id !== user.id) { %>
                        <div class="d-flex gap-1 justify-content-end">
                            <form action="/staff/<%= s.id %>/deactivate" method="POST" class="d-inline">
                                <button class="btn btn-sm <%= s.is_active ? 'btn-outline-danger' : 'btn-outline-success' %>">
                                    <%= s.is_active ? 'Deactivate' : 'Activate' %>
                                </button>
                            </form>
                            <button class="btn btn-sm btn-outline-dark" onclick="resetPassword(<%= s.id %>, '<%= s.full_name %>')">Reset PW</button>
                        </div>
                    <% } else { %>
                        <span class="text-muted small">Current user</span>
                    <% } %>
                </td>
            </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<!-- New Staff Modal -->
<div class="modal fade" id="newStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/staff" method="POST" class="modal-content border-0 rounded-0">
            <div class="modal-header bg-dark text-white border-0">
                <h5 class="modal-title">Register Personnel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold">FULL NAME</label>
                    <input type="text" name="full_name" class="form-control" required minlength="2">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">USERNAME</label>
                    <input type="text" name="username" class="form-control" required minlength="3" pattern="[a-zA-Z0-9_]+">
                    <div class="form-text">Letters, numbers, and underscores only</div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">PASSWORD</label>
                    <input type="password" name="password" class="form-control" required minlength="6">
                    <div class="form-text">Minimum 6 characters</div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">ROLE</label>
                    <select name="role" class="form-select">
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-primary w-100">CREATE ACCOUNT</button>
            </div>
        </form>
    </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPwModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <form id="resetPwForm" method="POST" class="modal-content border-0 rounded-0">
            <div class="modal-header bg-dark text-white border-0">
                <h6 class="modal-title">Reset Password</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="small text-muted mb-3">Resetting password for: <strong id="resetPwName"></strong></p>
                <div class="mb-3">
                    <label class="form-label small fw-bold">NEW PASSWORD</label>
                    <input type="password" name="new_password" class="form-control" required minlength="6">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-primary w-100">RESET PASSWORD</button>
            </div>
        </form>
    </div>
</div>

<script>
function resetPassword(id, name) {
    document.getElementById('resetPwForm').action = '/staff/' + id + '/reset-password';
    document.getElementById('resetPwName').textContent = name;
    new bootstrap.Modal(document.getElementById('resetPwModal')).show();
}
</script>

<%- include('partials/footer') %>
